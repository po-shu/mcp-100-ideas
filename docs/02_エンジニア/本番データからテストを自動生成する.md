# 本番データからテストを自動生成する

## アイデア
検証したい期間の本番トラフィックログとデータを安全にマスキングした上で、実際のユースケースに基づくE2Eテストとシステムテストのシナリオおよびテストケースを自動生成する。実データに基づく現実的なテストにより、従来見落としていたエッジケースの発見や、本番で実際によく使われるフローの優先的なテスト実施を可能にする。

### 具体例
マイクロサービス環境での決済システムにおいて、新機能リリース後2週間のトラフィックから、様々な決済パターンや特殊なエッジケースを収集。個人情報を適切にマスキングした上でtest-containersで再現可能なテストケースとして整理し、システム全体の品質を向上させる場面

## アーキテクチャ
| Type | Name | Role |
|--|--|--|
| Client | Claude Desktop App | テスト生成の対話型アシスタント |
| Server | PostgreSQL | 期間限定で収集したマスク済みログの分析基盤 |
| Server | GitHub | DDL・テストコード・データセットの管理 |

```mermaid
sequenceDiagram
    actor User as 品質保証エンジニア
    participant CAP as Claude Desktop App
    participant DB as PostgreSQL
    participant GH as GitHub
    
    Note over User,GH: 検証期間のみKinesis/Glueで<br>本番ログを収集・マスキング

    User->>CAP: 収集データの分析を依頼
    CAP->>DB: アクセスパターンを分析
    DB-->>CAP: 頻出フローを返却
    CAP->>GH: 既存テストを検索
    GH-->>CAP: テストコード・データを返却

    CAP-->>User: 有用なパターンを提案
    User->>CAP: リポジトリ反映を依頼

    CAP->>GH: スキーマ定義を取得
    GH-->>CAP: DDLを返却
    CAP-->>User: スキーマ更新要否を確認
    
    alt スキーマ更新が必要
        User->>CAP: スキーマ更新を依頼
        CAP->>GH: schemas/配下にPR作成
        GH-->>CAP: PR URLを返却
        CAP-->>User: スキーマPRの確認を依頼
        User->>CAP: スキーマPRの承認通知
    end

    User->>CAP: テストケース生成を依頼
    CAP->>DB: 対象パターンのログを取得
    DB-->>CAP: 詳細シーケンスを返却
    CAP->>GH: scenarios/配下にPR作成
    Note over CAP,GH: - シナリオメタデータ<br>- セットアップSQL<br>- 期待値定義
    GH-->>CAP: PR URLを返却
    
    User->>CAP: テストデータ生成を依頼
    CAP->>DB: 本番データのパターンを分析
    DB-->>CAP: 特徴的なケースを返却
    CAP->>GH: datasets/配下にPR作成
    GH-->>CAP: PR URLを返却
    CAP-->>User: レビュー依頼を通知

    Note over User,GH: 各マイクロサービスは<br>test-containersでリポジトリを参照
```

## 思考プロセス

### 対象の活動の価値は何か
- 本番環境の実データに基づくテスト品質の向上
    - 実際のユースケースの網羅
    - エッジケースの発見
    - データの現実性担保
- テスト作成工数の削減と再利用性の向上
    - DDL・テストケース・データの一元管理
    - test-containersによる環境の統一
    - コード実装の自動化
- プライバシーとセキュリティの確保
    - 確実なデータマスキング
    - 機密情報の除去
    - コンプライアンス対応

### 価値を妨げる課題は何か
- データ収集とマスキングの複雑さ
    - 個人情報の特定
    - 機密データの判別
    - 整合性の維持
- テストシナリオの妥当性検証
    - 異常系の扱い
    - パフォーマンス要件
    - 依存関係の考慮
- test-containers環境の制約
    - 外部サービス連携
    - データ量の制限
    - リソースの制約

### なぜ課題が発生するのか、仮説推論
- システムの複雑性
    - マイクロサービス間の依存
    - 非同期処理の存在
    - 外部サービス連携
- データの特性
    - 構造化/非構造化の混在
    - 時系列での変化
    - ビジネスルールの影響
- 運用上の制約
    - プライバシー規制
    - パフォーマンス要件
    - リソースコスト